- name: Veth configure # TODO: переписать на нормальный Ansible
  become: yes
  shell: |
    ip link add veth0 type veth peer name veth1
    ip link set dev veth0 up
    
    ip link add veth2 type veth peer name veth3
    ip link set dev veth3 up
    
    ip link add xeth0 type veth peer name xeth1
    ip link set dev xeth0 up
    ip link set dev xeth1 up
    
    ip netns add sfc
    ip link set veth1 netns sfc
    ip link set veth2 netns sfc
    ip netns exec sfc brctl addbr br0
    ip netns exec sfc brctl addif br0 veth1
    ip netns exec sfc brctl addif br0 veth2
    ip netns exec sfc ifconfig br0 up
    ip netns exec sfc ip addr add 1.2.3.4/32 dev br0
    
    ovs-vsctl add-br br0
    ip link set br0 up
    ovs-vsctl add-port br0 vxlan0
    
    ovs-vsctl set interface vxlan0 type=vxlan options:remote_ip=flow options:exts=gpe options:nshc1=flow options:nshc2=flow options:nshc3=flow options:nshc4=flow options:nsi=flow options:nsp=flow options:key=flow options:dst_port="6633"
    
    ovs-vsctl add-port br0 veth0
    ovs-vsctl add-port br0 veth3
    ovs-vsctl add-port br0 xeth0
    ovs-vsctl add-port br0 xeth1
    ovs-vsctl set interface veth0 ofport_request=1
    ovs-vsctl set interface veth3 ofport_request=2
    ovs-vsctl set interface xeth0 ofport_request=3
    ovs-vsctl set interface xeth1 ofport_request=4
    ovs-vsctl set interface vxlan0 ofport_request=5

# TODO: дописать команды для перезагрузки ovs
- name: REST API to /restconf/operations/rendered-service-path:read-rendered-service-path-first-hop
  uri:
    body: '{"input": {"name": {{ item.key }}}}'
    body_format: json
    method: POST
    password: "{{ controller['password'] }}"
    status_code:
      - 201
      - 200
    url: http://{{ controller['ip-address'] }}:{{ controller['port'] }}/restconf/operations/rendered-service-path:read-rendered-service-path-first-hop
    user: "{{ controller['user'] }}"
  with_dict: "{{ service_function_chains }}"
  register: paths

- shell: |
    ovs-ofctl add-flow br0 "priority=1000,nsi={{ item.json.output['rendered-service-path-first-hop']['starting-index'] - item.item.value }},nsp={{ item.json.output['rendered-service-path-first-hop']['path-id'] }} actions=pop_nsh,output:3"
    ovs-ofctl add-flow br0 "priority=1,in_port=4,actions=push_nsh,load:0x1->NXM_NX_NSH_MDTYPE[],load:0x3->NXM_NX_NSH_NP[],load:{{ '%#x' % item.json.output['rendered-service-path-first-hop']['path-id'] }}->NXM_NX_NSP[0..23],load:{{ '%#x' % (item.json.output['rendered-service-path-first-hop']['starting-index'] - item.item.value - 1) }}->NXM_NX_NSI[],load:0x1->NXM_NX_NSH_C1[],load:0x2->NXM_NX_NSH_C2[],load:0x3->NXM_NX_NSH_C3[],load:0x4->NXM_NX_NSH_C4[],load:0x4->NXM_NX_TUN_GPE_NP[],load:0x{{ forwarder['ip-address'] | ip4_hex }}->NXM_NX_TUN_IPV4_DST[],output:5"
  with_items: "{{ paths.results }}"
  when: "'Reverse' in item.item.key"

- shell: |
    ovs-ofctl add-flow br0 "priority=1000,nsi={{ item.json.output['rendered-service-path-first-hop']['starting-index'] - item.item.value }},nsp={{ item.json.output['rendered-service-path-first-hop']['path-id'] }} actions=pop_nsh,output:1"
    ovs-ofctl add-flow br0 "priority=1,in_port=2,actions=push_nsh,load:0x1->NXM_NX_NSH_MDTYPE[],load:0x3->NXM_NX_NSH_NP[],load:{{ '%#x' % item.json.output['rendered-service-path-first-hop']['path-id'] }}->NXM_NX_NSP[0..23],load:{{ '%#x' % (item.json.output['rendered-service-path-first-hop']['starting-index'] - item.item.value - 1) }}->NXM_NX_NSI[],load:0x1->NXM_NX_NSH_C1[],load:0x2->NXM_NX_NSH_C2[],load:0x3->NXM_NX_NSH_C3[],load:0x4->NXM_NX_NSH_C4[],load:0x4->NXM_NX_TUN_GPE_NP[],load:0x{{ forwarder['ip-address'] | ip4_hex }}->NXM_NX_TUN_IPV4_DST[],output:5"
  with_items: "{{ paths.results }}"
  when: "'Reverse' not in item.item.key"
