- name: Install required packages
  become: yes
  apt:
    name: "{{ item }}"
    state: latest
    update_cache: yes
  loop: ['curl', 'git', 'bridge-utils']

- name: Ovs configure
  become: yes
  shell: |
    echo "Removing old ovs configuration."
    sudo /etc/init.d/openvswitch-switch stop
    sudo kill `cd /usr/local/var/run/openvswitch && cat ovsdb-server.pid ovs-vswitchd.pid`
    sudo rm -rf /usr/local/var/run/openvswitch
    sudo mkdir -p /usr/local/var/run/openvswitch
    sudo rm -rf /usr/local/etc/openvswitch
    sudo mkdir -p /usr/local/etc/openvswitch
    sudo rm -rf /var/run/openvswitch
    sudo mkdir -p /var/run/openvswitch
    sudo rm -rf /etc/openvswitch
    sudo mkdir -p /etc/openvswitch
    sudo rm -rf /var/log/openvswitch
    sudo mkdir -p /var/log/openvswitch
    sudo rmmod openvswitch
    sudo rmmod gre
    sudo rmmod vxlan
    sudo rmmod libcrc32c
    sudo rmmod openvswitch
    sudo dpkg --force-all --purge openvswitch-switch
    sudo dpkg --force-all --purge openvswitch-common
    sudo dpkg --force-all --purge openvswitch-datapath-dkms
    sudo rm /tmp/ovsdb.txt
    touch /tmp/ovsdb.txt
    sudo rm /tmp/vswitch.txt
    touch /tmp/vswitch.txt
    git clone https://github.com/openvswitch/ovs.git
    git clone https://github.com/yyang13/ovs_nsh_patches.git
    cd ovs
    git config user.email "yi.y.yang@intel.com"
    git config user.name "Yi Yang"
    git reset --hard 7d433ae57ebb90cd68e8fa948a096f619ac4e2d8
    git am ../ovs_nsh_patches/*.patch
    make clean
    ./boot.sh
    ./configure --with-linux=/lib/modules/`uname -r`/build
    sudo make uninstall
    sudo apt-get update
    sudo apt-get install -y build-essential
    sudo apt-get install -y fakeroot
    sudo apt-get install -y debhelper
    sudo apt-get install -y autoconf
    sudo apt-get install -y automake
    sudo apt-get install -y libssl-dev
    sudo apt-get install -y bzip2
    sudo apt-get install -y openssl
    sudo apt-get install -y graphviz
    sudo apt-get install -y python-all
    sudo apt-get install -y procps
    sudo apt-get install -y python-qt4
    sudo apt-get install -y python-zopeinterface
    sudo apt-get install -y python-twisted-conch
    sudo apt-get install -y libtool
    sudo apt-get install -y dh-autoreconf
    echo "Checking Build Dependencies."
    sudo dpkg-checkbuilddeps
    if [ $? -gt 0 ]; then
        echo "ERROR:Build Dependencies not met."
        exit 1
    fi

    echo "Creating Debian Packages."
    rm ../openvswitch-*.deb
    rm ../python-openvswitch*.deb
    DEB_BUILD_OPTIONS='parallel=8 nocheck' fakeroot debian/rules binary
    if [ $? -gt 0 ]; then
        echo "ERROR:Creating Debian packages failed."
        exit 1
    fi

    echo "Installing kernel module using dkms."
    sudo apt-get install -y linux-headers-`uname -r`
    sudo apt-get install -y dkms
    sudo dpkg --install ../openvswitch-datapath-dkms*
    if [ $? -gt 0 ]; then
        echo "ERROR:Installing openvswitch kernel module failed."
        exit 1
    fi

    echo "Installing openvswitch userland packages."
    sudo dpkg --install ../openvswitch-common*
    sudo dpkg --install ../openvswitch-switch*
    if [ $? -gt 0 ]; then
        echo "ERROR:Installing openvswitch userland packages failed."
        exit 1
    fi

    sudo /etc/init.d/openvswitch-switch restart

    sudo lsmod | grep -i open
    sudo update-rc.d -f openvswitch-switch remove
    sudo ovs-vsctl show

    echo "Install Complete!"
    exit 0

- name: Ovs configure
  become: yes
  shell: |
    ip link add veth0 type veth peer name veth1
    ip link set dev veth0 up

    ip link add veth2 type veth peer name veth3
    ip link set dev veth3 up

    ip link add xeth0 type veth peer name xeth1
    ip link set dev xeth0 up
    ip link set dev xeth1 up

    ip netns add sfc
    ip link set veth1 netns sfc
    ip link set veth2 netns sfc
    sudo ip netns exec sfc brctl addbr br0
    sudo ip netns exec sfc brctl addif br0 veth1
    sudo ip netns exec sfc brctl addif br0 veth2
    sudo ip netns exec sfc ifconfig br0 up
    sudo ip netns exec sfc ip addr add 1.2.3.4/32 dev br0

    ovs-vsctl add-br br0
    ip link set br0 up
    ovs-vsctl add-port br0 vxlan0

    ovs-vsctl set interface vxlan0 type=vxlan options:remote_ip=flow options:exts=gpe options:nshc1=flow options:nshc2=flow options:nshc3=flow options:nshc4=flow options:nsi=flow options:nsp=flow options:key=flow options:dst_port="6633"

    ovs-vsctl add-port br0 veth0
    ovs-vsctl add-port br0 veth3
    ovs-vsctl add-port br0 xeth0
    ovs-vsctl add-port br0 xeth1
    ovs-vsctl set interface veth0 ofport_request=1
    ovs-vsctl set interface veth3 ofport_request=2
    ovs-vsctl set interface xeth0 ofport_request=3
    ovs-vsctl set interface xeth1 ofport_request=4
    ovs-vsctl set interface vxlan0 ofport_request=5
    
    ovs-ofctl add-flow br0 "priority=1000,nsi=254,nsp=8389843 actions=pop_nsh,output:3"
    ovs-ofctl add-flow br0 "priority=1000,nsi=254,nsp=1235 actions=pop_nsh,output:1"
    ovs-ofctl add-flow br0 "priority=1,in_port=2,actions=push_nsh,load:0x1->NXM_NX_NSH_MDTYPE[],load:0x3->NXM_NX_NSH_NP[],load:0x4d3->NXM_NX_NSP[0..23],load:0xfd->NXM_NX_NSI[],load:0x1->NXM_NX_NSH_C1[],load:0x2->NXM_NX_NSH_C2[],load:0x3->NXM_NX_NSH_C3[],load:0x4->NXM_NX_NSH_C4[],load:0x4->NXM_NX_TUN_GPE_NP[],load:0xc0a8012c->NXM_NX_TUN_IPV4_DST[],output:5"
    ovs-ofctl add-flow br0 "priority=1,in_port=4,actions=push_nsh,load:0x1->NXM_NX_NSH_MDTYPE[],load:0x3->NXM_NX_NSH_NP[],load:0x8004d3->NXM_NX_NSP[0..23],load:0xfd->NXM_NX_NSI[],load:0x1->NXM_NX_NSH_C1[],load:0x2->NXM_NX_NSH_C2[],load:0x3->NXM_NX_NSH_C3[],load:0x4->NXM_NX_NSH_C4[],load:0x4->NXM_NX_TUN_GPE_NP[],load:0xc0a8012c->NXM_NX_TUN_IPV4_DST[],output:5"
